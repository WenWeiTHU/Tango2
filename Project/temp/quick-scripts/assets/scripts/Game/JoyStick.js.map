{"version":3,"sources":["JoyStick.js"],"names":["cc","Class","extends","Component","properties","Stick","type","Node","default","Ring","ShieldBtn","ShieldLabel","Label","ShieldPrefab","Prefab","Player","Max_r","ShieldDuartion","start","shieldLabel","getComponent","player","getComponents","Speed","speed","string","shield","x","y","dir","v2","newShield","instantiate","node","parent","addChild","name","active","initEvent","on","EventType","TOUCH_START","e","wPos","getLocation","pos","convertToNodeSpaceAR","len","mag","setPosition","generateShield","TOUCH_MOVE","TOUCH_END","TOUCH_CANCEL","setTimeout","bind","updatePos","dt","collideMap","updateDir","r","Math","atan2","degree","PI","rotation","update"],"mappings":"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","file":"JoyStick.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\Game","sourcesContent":["/*\n * 摇杆控制脚本\n */\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    Stick: {\n      type: cc.Node,\n      default: null\n    },\n    Ring: {\n      type: cc.Node,\n      default: null\n    },\n    ShieldBtn: {\n      type: cc.Node,\n      default: null\n    },\n    ShieldLabel: {\n      type: cc.Label,\n      default: null\n    },\n    ShieldPrefab: {\n      default: null,\n      type: cc.Prefab\n    },\n    Player: {\n      type: cc.Node,\n      default: null\n    },\n    Max_r: 100, // 摇杆可触碰半径\n    ShieldDuartion: 5 // 护盾持续时长\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  // onLoad () {},\n\n  /*\n     * 初始化函数\n     * 功能：初始化脚本的设定\n     */\n  start () {\n    this.shieldLabel = this.ShieldLabel.getComponent(cc.Label)\n    this.player = this.Player.getComponents('Player')[0]\n    this.Speed = this.player.speed\n    this.shieldLabel.string = this.player.shield\n\n    this.Stick.x = 0\n    this.Stick.y = 0\n    this.dir = cc.v2(0, 0)\n\n    this.newShield = cc.instantiate(this.ShieldPrefab)\n    this.node.parent.addChild(this.newShield)\n    this.newShield.x = this.Player.x\n    this.newShield.y = this.Player.y\n\n    if (this.node.name === 'stickLeft') {\n      this.newShield.name = 'shieldLeft'\n    } else {\n      this.newShield.name = 'shieldRight'\n    }\n\n    this.newShield.active = false\n\n    this.initEvent()\n  },\n\n  /*\n     * 初始化回调函数\n     * 功能：初始化各个组件的回调函数\n     */\n  initEvent () {\n    this.Ring.on(cc.Node.EventType.TOUCH_START, function (e) {\n      var wPos = e.getLocation()\n      this.pos = this.node.convertToNodeSpaceAR(wPos)\n      var len = this.pos.mag() // 获取向量长度\n      this.dir.x = this.pos.x / len\n      this.dir.y = this.pos.y / len\n      if (len > this.Max_r) {\n        this.pos.x = this.Max_r * this.pos.x / len\n        this.pos.y = this.Max_r * this.pos.y / len\n      }\n      this.Stick.setPosition(this.pos)\n    }, this)\n\n    this.ShieldBtn.on(cc.Node.EventType.TOUCH_START, function (e) {\n      this.generateShield()\n    }, this)\n\n    this.Ring.on(cc.Node.EventType.TOUCH_MOVE, function (e) {\n      var wPos = e.getLocation()\n      this.pos = this.node.convertToNodeSpaceAR(wPos)\n      var len = this.pos.mag()\n      this.dir.x = this.pos.x / len\n      this.dir.y = this.pos.y / len\n      if (len > this.Max_r) {\n        this.pos.x = this.Max_r * this.pos.x / len\n        this.pos.y = this.Max_r * this.pos.y / len\n      }\n      this.Stick.setPosition(this.pos)\n    }, this)\n\n    this.Ring.on(cc.Node.EventType.TOUCH_END, function (e) {\n      this.Stick.setPosition(cc.v2(0, 0))\n      this.dir = cc.v2(0, 0)\n    }, this)\n\n    this.Ring.on(cc.Node.EventType.TOUCH_CANCEL, function (e) {\n      this.Stick.setPosition(cc.v2(0, 0))\n      this.dir = cc.v2(0, 0)\n    }, this)\n  },\n\n  /*\n     * 护盾生成函数\n     * 功能：为主角生成一个护盾\n     */\n  generateShield: function () {\n    if (this.player.shield <= 0) {\n      return\n    }\n\n    this.player.shield--\n    this.shieldLabel.string = this.player.shield\n\n    this.newShield.active = true\n\n    setTimeout(function () {\n      this.active = false\n    }.bind(this.newShield), 1000 * this.ShieldDuartion)\n  },\n\n  /*\n     * 位置更新函数\n     * 功能：更新主角和护盾的位置\n     */\n  updatePos (dt) {\n    if (this.newShield !== null) {\n      this.newShield.x = this.Player.x\n      this.newShield.y = this.Player.y\n    }\n\n    if (this.dir.mag() < 0.5) {\n      return\n    }\n\n    if (!this.player.collideMap) {\n      this.Player.x += this.Speed * this.dir.x * this.pos.mag() / (this.dir.mag() * this.Max_r)\n      this.Player.y += this.Speed * this.dir.y * this.pos.mag() / (this.dir.mag() * this.Max_r)\n    }\n  },\n\n  /*\n     * 方向更新函数\n     * 功能：更新主角的旋转方向\n     */\n  updateDir () {\n    var r = Math.atan2(this.dir.y, this.dir.x)\n    var degree = r * 180 / (Math.PI)\n    degree = 360 - degree + 90\n    this.Player.rotation = degree\n  },\n\n  update (dt) {\n    this.updatePos(dt)\n    this.updateDir()\n  }\n})\n"]}